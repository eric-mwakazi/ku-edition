---
- name: Deploy a kubernetes dashboard.
  hosts: proxy-blue, proxy-green
  tasks:
    - name: Apply kubernetes dashboard manifests.
      kubernetes.core.k8s:
        kubeconfig: /home/eric/.kube/config
        definition: "{{ lookup('file', '/root/ansible/k8s-manifests/recommended.yaml') }}"
        state: present

    - name: Apply dashboard admin panel manifest.
      kubernetes.core.k8s:
        kubeconfig: /home/eric/.kube/config
        definition: "{{ lookup('file', '/root/ansible/k8s-manifests/dashboard-admin.yaml') }}"
        state: present

    - name: Apply dashboard admin ClusterRoleBinding manifest.
      kubernetes.core.k8s:
        kubeconfig: /home/eric/.kube/config
        definition: "{{ lookup('file', '/root/ansible/k8s-manifests/dashboard-admin-bind-cluster-role.yaml') }}"
        state: present

    - name: Apply metrics components manifest.
      kubernetes.core.k8s:
        kubeconfig: /home/eric/.kube/config
        definition: "{{ lookup('file', '/root/ansible/k8s-manifests/components.yaml') }}"
        state: present

    - name: Create a bearer koken for the admin-user.
      command: kubectl --kubeconfig /home/eric/.kube/config -n kubernetes-dashboard create token admin-user
      register: token_output

    - name: Write bearer token to a file.
      copy:
        content: "{{ token_output.stdout }}"
        dest: $HOME/token.txt

    - name: Show the bearer token.
      debug:
        msg: "Bearer Token written to $HOME/token.txt"